<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>European Birdwatching Assistant</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .chat-container {
            max-width: 1200px;
            height: 85vh;
            border-radius: 1rem;
        }
        .message-input-container {
            backdrop-filter: blur(8px);
        }
        /* Custom scrollbar styles */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        .bird-list-container {
            height: 100%;
            overflow-y: auto;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="chat-container flex flex-col bg-white shadow-xl p-6 md:flex-row gap-6">

        <!-- Left Column: Bird List -->
        <div class="flex-1 flex flex-col h-full bg-gray-50 rounded-xl p-4 shadow-inner">
            <h2 class="text-xl font-bold text-gray-800 mb-2">European Birds</h2>
            <div id="bird-list-container" class="bird-list-container bg-white rounded-lg p-2 shadow-inner">
                <!-- Bird list will be populated here by JavaScript -->
            </div>
        </div>

        <!-- Middle Column: Chat UI -->
        <div class="flex-[2] flex flex-col h-full bg-gray-50 rounded-xl p-4 shadow-inner">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-4 text-center">Your Birdwatching Assistant</h1>

            <!-- Chat Messages Section -->
            <div id="chat-messages" class="flex-1 overflow-y-auto space-y-4 p-2 mb-4 chat-messages">
                <!-- Initial greeting message -->
                <div class="flex justify-start">
                    <div class="bg-gray-200 text-gray-800 p-4 rounded-xl max-w-[80%]">
                        Hello! I'm your European birdwatching expert. Ask me about a specific bird, or for general birdwatching tips.
                    </div>
                </div>
            </div>
            
            <!-- Example queries section -->
            <div id="example-queries" class="flex flex-wrap justify-center gap-2 mb-4">
                <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm hover:bg-gray-300 transition duration-200 ease-in-out">What does a European Robin look like?</button>
                <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm hover:bg-gray-300 transition duration-200 ease-in-out">How can I attract birds to my garden?</button>
            </div>

            <!-- Input area -->
            <div class="message-input-container flex items-center p-2 bg-white rounded-full shadow-lg border border-gray-200">
                <input type="text" id="user-input" placeholder="Ask a question about birds..." class="flex-1 p-3 bg-transparent outline-none rounded-full text-gray-800">
                <button id="send-btn" class="flex items-center justify-center bg-blue-500 text-white w-12 h-12 rounded-full transition duration-200 ease-in-out hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <span id="send-btn-text" class="hidden">Send</span>
                    <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <svg id="send-icon" class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Right Column: Image Display -->
        <div class="flex-1 flex flex-col items-center justify-center bg-gray-50 rounded-xl p-4 shadow-inner">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Featured Image</h2>
            <div id="image-container" class="w-full h-full flex items-center justify-center bg-gray-200 rounded-xl">
                <span class="p-4 text-gray-600 rounded-md bg-white/50 backdrop-blur-md">
                    Wikipedia Image Placeholder
                </span>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const sendBtnText = document.getElementById('send-btn-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const imageContainer = document.getElementById('image-container');
        const exampleQueries = document.getElementById('example-queries');
        const birdListContainer = document.getElementById('bird-list-container');
        
        const birds = [
            "Mute Swan", "Whooper Swan", "Bewick's Swan", "Greylag Goose", "Canada Goose", "Barnacle Goose",
            "Egyptian Goose", "Shelduck", "Mallard", "Gadwall", "Teal", "Pintail", "Shoveler", "Pochard",
            "Tufted Duck", "Scaup", "Eider", "Long-tailed Duck", "Goldeneye", "Smew", "Red-breasted Merganser",
            "Goosander", "Velvet Scoter",
            "Common Pheasant", "Grey Partridge", "Red-legged Partridge", "Common Quail",
            "Little Grebe", "Great Crested Grebe", "Red-necked Grebe", "Slavonian Grebe", "Black-necked Grebe",
            "Rock Dove", "Stock Dove", "Wood Pigeon", "Collared Dove", "Turtle Dove",
            "Common Cuckoo",
            "Nightjar",
            "Common Swift", "Pallid Swift", "Alpine Swift",
            "Water Rail", "Spotted Crake", "Corn Crake", "Moorhen", "Coot",
            "Common Crane",
            "Great Bustard", "Little Bustard",
            "Eurasian Oystercatcher",
            "Northern Lapwing", "Little Ringed Plover", "Ringed Plover", "Kentish Plover", "Golden Plover",
            "Grey Plover", "Dotterel",
            "Common Snipe", "Jack Snipe", "Woodcock", "Black-tailed Godwit", "Bar-tailed Godwit",
            "Whimbrel", "Curlew", "Spotted Redshank", "Redshank", "Greenshank", "Green Sandpiper",
            "Wood Sandpiper", "Common Sandpiper", "Turnstone", "Knot", "Sanderling", "Little Stint",
            "Temminck's Stint", "Dunlin", "Ruff", "Avocet",
            "Great Skua", "Arctic Skua", "Pomarine Skua", "Long-tailed Skua", "Mediterranean Gull",
            "Black-headed Gull", "Little Gull", "Common Gull", "Lesser Black-backed Gull",
            "Herring Gull", "Yellow-legged Gull", "Great Black-backed Gull", "Kittiwake", "Sabine's Gull",
            "Ivory Gull", "Glaucous Gull",
            "Little Tern", "Sandwich Tern", "Common Tern", "Arctic Tern", "Roseate Tern", "Black Tern",
            "White-winged Black Tern",
            "Guillemot", "Razorbill", "Black Guillemot", "Little Auk", "Puffin",
            "White Stork", "Black Stork",
            "Great Bittern", "Little Bittern", "Grey Heron", "Purple Heron", "Great Egret", "Little Egret",
            "Cattle Egret", "Squacco Heron", "Night Heron",
            "Glossy Ibis", "Spoonbill",
            "Honey Buzzard", "Black Kite", "Red Kite", "White-tailed Eagle", "Golden Eagle",
            "Short-toed Eagle", "Marsh Harrier", "Hen Harrier", "Montagu's Harrier", "Goshawk",
            "Sparrowhawk", "Buzzard", "Rough-legged Buzzard", "Osprey", "Kestrel", "Red-footed Falcon",
            "Merlin", "Hobby", "Peregrine Falcon",
            "Barn Owl", "Scops Owl", "Eagle Owl", "Tawny Owl", "Long-eared Owl", "Short-eared Owl",
            "Little Owl", "Pygmy Owl",
            "Common Kingfisher",
            "Wryneck", "Green Woodpecker", "Great Spotted Woodpecker", "Middle Spotted Woodpecker",
            "Lesser Spotted Woodpecker", "Black Woodpecker", "Grey-headed Woodpecker",
            "Woodlark", "Skylark", "Crested Lark", "Shore Lark",
            "Sand Martin", "Swallow", "House Martin", "Red-rumped Swallow",
            "Tree Pipit", "Meadow Pipit", "Rock Pipit", "Water Pipit", "White Wagtail", "Grey Wagtail",
            "Yellow Wagtail",
            "Waxwing",
            "White-throated Dipper",
            "Eurasian Wren",
            "Dunnock",
            "European Robin", "Common Nightingale", "Bluethroat", "Redstart", "Black Redstart",
            "Stonechat", "Whinchat", "Wheatear",
            "Ring Ouzel", "Blackbird", "Fieldfare", "Song Thrush", "Redwing", "Mistle Thrush",
            "Cetti's Warbler", "Sedge Warbler", "Reed Warbler", "Marsh Warbler", "Icterine Warbler",
            "Willow Warbler", "Common Chiffchaff", "Wood Warbler", "Greenish Warbler", "Arctic Warbler",
            "Bonelli's Warbler", "Garden Warbler", "Blackcap", "Lesser Whitethroat", "Common Whitethroat",
            "Dartford Warbler", "Subalpine Warbler", "Sardinian Warbler", "Melodious Warbler",
            "Spotted Flycatcher", "Pied Flycatcher", "Collared Flycatcher", "Red-breasted Flycatcher",
            "Coal Tit", "Marsh Tit", "Willow Tit", "Crested Tit", "Blue Tit", "Great Tit", "Long-tailed Tit",
            "Eurasian Nuthatch",
            "Eurasian Treecreeper", "Short-toed Treecreeper",
            "Red-backed Shrike", "Lesser Grey Shrike", "Woodchat Shrike",
            "Eurasian Jay", "Magpie", "Spotted Nutcracker", "Chough", "Jackdaw", "Rook", "Carrion Crow",
            "Hooded Crow", "Raven",
            "European Starling", "Rose-coloured Starling",
            "House Sparrow", "Tree Sparrow",
            "Chaffinch", "Brambling", "Hawfinch", "Greenfinch", "Goldfinch", "Siskin", "Linnet",
            "Twite", "Common Redpoll", "Arctic Redpoll", "Two-barred Crossbill", "Common Crossbill",
            "Parrot Crossbill", "Bullfinch",
            "Yellowhammer", "Cirl Bunting", "Rock Bunting", "Ortolan Bunting", "Reed Bunting",
            "Corn Bunting", "Lapland Bunting", "Snow Bunting",
            "Bearded Reedling", "Penduline Tit", "Golden Oriole", "Hoopoe", "Hawfinch", "Wryneck"
        ];
        
        const addMessage = (text, sender, transcription = null) => {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'mb-4');

            let contentHTML = `<span>${text}</span>`;
            if (transcription) {
                contentHTML = `<strong>(Transcription)</strong><br>${contentHTML}`;
            }

            if (sender === 'user') {
                messageDiv.classList.add('justify-end');
                messageDiv.innerHTML = `<div class="bg-blue-500 text-white p-4 rounded-xl max-w-[80%] break-words">${contentHTML}</div>`;
            } else {
                messageDiv.classList.add('justify-start');
                messageDiv.innerHTML = `<div class="bg-gray-100 text-gray-800 p-4 rounded-xl max-w-[80%] flex items-center space-x-2 bot-message break-words"><span>${contentHTML}</span></div>`;
            }
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        const displayImage = (imageUrl) => {
            imageContainer.innerHTML = '';

            if (imageUrl) {
                const imgElement = document.createElement('img');
                imgElement.src = imageUrl;
                imgElement.alt = "Bird image from Wikipedia";
                imgElement.classList.add(
                    'w-full',
                    'h-auto',
                    'object-contain',
                    'rounded-xl',
                    'shadow'
                );
                imageContainer.appendChild(imgElement);
            } else {
                imageContainer.innerHTML = `
                    <span class="p-4 text-gray-600 rounded-md bg-white/50 backdrop-blur-md">
                        Wikipedia Image Placeholder
                    </span>
                `;
            }
        };

        const showLoading = () => {
            sendBtnText.textContent = '...';
            loadingSpinner.style.display = 'block';
            sendBtn.disabled = true;
            userInput.disabled = true;
        };

        const hideLoading = () => {
            sendBtnText.textContent = 'Send';
            loadingSpinner.style.display = 'none';
            sendBtn.disabled = false;
            userInput.disabled = false;
        };

        // Helper function to extract and remove markdown image URL
        const processMarkdown = (text) => {
            const regex = /!\[.*?\]\((.*?)\)/;
            const match = text.match(regex);
            if (match) {
                const imageUrl = match[1];
                const cleanedText = text.replace(regex, '').trim();
                return { text: cleanedText, imageUrl: imageUrl };
            }
            return { text: text, imageUrl: null };
        };

        const sendMessage = async () => {
            const message = userInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            userInput.value = '';
            showLoading();

            try {
                const response = await fetch('http://localhost:5000/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                hideLoading();
                
                // Process the markdown response from the backend
                const processed = processMarkdown(data.response);
                addMessage(processed.text, 'bot');
                displayImage(processed.imageUrl);

            } catch (error) {
                console.error('Error fetching bot response:', error);
                hideLoading();
                addMessage("Sorry, I couldn't connect to the server. Please check your backend.", 'bot');
            }
        };

        // Function to render the bird list
        const renderBirdList = () => {
            birds.forEach(bird => {
                const birdButton = document.createElement('button');
                birdButton.classList.add(
                    'block',
                    'w-full',
                    'px-4',
                    'py-2',
                    'mb-1',
                    'bg-gray-100',
                    'text-gray-700',
                    'rounded-lg',
                    'text-left',
                    'hover:bg-gray-200',
                    'transition',
                    'duration-200',
                    'ease-in-out'
                );
                birdButton.textContent = bird;
                birdListContainer.appendChild(birdButton);
            });
        };

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        exampleQueries.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON') {
                userInput.value = event.target.textContent.trim();
                sendMessage();
            }
        });

        birdListContainer.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON') {
                userInput.value = event.target.textContent.trim();
                sendMessage();
            }
        });

        // Initial render of the bird list
        renderBirdList();
    });
    </script>
</body>
</html>
