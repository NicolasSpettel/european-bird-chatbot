<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>European Birdwatching Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .background-image {
            background-image: url('https://image.jimcdn.com/app/cms/image/transf/none/path/sa6549607c78f5c11/image/i085c7d187a56151e/version/1482853751/madeira-hummingbird-best-bird-watching-destinations-in-europe-copyright-lukasz-janyst-european-best-destinations-european-best-destinations.jpg');
            background-size: cover;
            background-position: center;
            filter: brightness(0.7);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        .chat-container {
            max-width: 1200px;
            height: 85vh;
            border-radius: 1rem;
            backdrop-filter: blur(5px);
            background-color: rgba(31, 41, 55, 0.6);
            margin: auto; 
            display: flex;
            flex-direction: row;
            gap: 6px;
            padding: 20px;
            position: relative;
        }
        .message-input-container {
            backdrop-filter: blur(8px);
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 10px;
        }
        #bird-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
            background-color: rgba(31, 41, 55, 0.7);
            padding: 20px;
            overflow-y: auto;
            color: white;
            z-index: 10;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }
        #bird-sidebar h2 {
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
        }
        #bird-list-container {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

        .body-content-wrapper {
            margin-left: 280px;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        #project-info-box {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 250px;
            height: 200px;
            background-color: rgba(75, 85, 99, 0.7);
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            color: white;
            z-index: 5;
            overflow-y: auto;
        }
        #project-info-box h2 {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
        }
        #project-info-box p {
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .main-chat-area {
            flex: 2;
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: transparent;
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: none;
        }

        .image-audio-info-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: transparent;
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: none;
            position: relative;
            justify-content: flex-start;
        }
        .image-audio-info-area #image-container {
            flex-grow: 0;
            max-height: 300px;
            min-height: 200px;
            margin-bottom: 1rem;
        }
        .image-audio-info-area #audio-player-container {
            flex-shrink: 0;
        }

        #chat-messages {
            flex-grow: 1;
        }

        .message-input-container {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            margin-top: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #reset-memory-btn {
            position: absolute;
            right: 20px;
            bottom: 20px;
            z-index: 20;
            width: 50px;
            height: 50px;
            background-color: rgba(253, 224, 71, 0.8);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
        }
        #reset-memory-btn:hover {
            background-color: rgba(253, 224, 71, 1);
            transform: scale(1.05);
        }
        #reset-status-message {
            position: absolute;
            right: 80px;
            bottom: 35px;
            z-index: 20;
            white-space: nowrap;
        }

        .transparent-bg {
            background-color: transparent;
        }
    </style>
</head>
<body class="flex min-h-screen">
    <div class="background-image"></div>
    
    <div id="bird-sidebar">
        <h2 class="text-xl font-bold text-white mb-2">Click on a bird to learn about it</h2>
        <div id="bird-list-container" class="bird-list-container text-white rounded-lg p-2 shadow-inner">
        </div>
    </div>

    <div class="body-content-wrapper">
        <div class="chat-container flex flex-col shadow-xl p-6 md:flex-row gap-6">

            <div class="main-chat-area flex-[3] flex flex-col h-full rounded-xl p-4">
                <h1 class="text-3xl font-extrabold text-white mb-4 text-center">Apollo, Bird Expert</h1>

                <div id="chat-messages" class="flex-1 overflow-y-auto space-y-4 p-2 mb-4 chat-messages">
                    <div class="flex justify-start">
                        <div class="bg-gray-200/80 text-gray-800 p-4 rounded-xl max-w-[80%] flex items-center space-x-2 bot-message break-words">
                            <img src="https://img.freepik.com/premium-photo/hyperrealistic-portraiture-parrot-with-glasses_899449-28389.jpg" alt="Bot Avatar" class="w-8 h-8 rounded-full">
                            <span>Hello! I'm Apollo, your birdwatching expert in Europe. Ask me about a specific bird, or for general birdwatching tips.</span>
                            <button class="tts-btn ml-2" title="Listen">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="example-queries" class="flex flex-wrap justify-center gap-2 mb-4">
                    <button class="px-4 py-2 bg-gray-600/70 text-white rounded-full text-sm hover:bg-gray-500/70 transition duration-200 ease-in-out">What does a European Robin look like?</button>
                    <button class="px-4 py-2 bg-gray-600/70 text-white rounded-full text-sm hover:bg-gray-500/70 transition duration-200 ease-in-out">How can I attract birds to my garden?</button>
                </div>

                <div class="message-input-container flex items-center p-2 rounded-full shadow-lg">
                    <button id="mic-btn" class="flex items-center justify-center bg-red-500/80 text-white w-12 h-12 rounded-full transition duration-200 ease-in-out hover:bg-red-600/80 focus:outline-none focus:ring-2 focus:ring-red-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2a3 3 0 00-3 3v6a3 3 0 006 0V5a3 3 0 00-3-3zM19 10v1a7 7 0 01-14 0v-1M12 18.5a.5.5 0 00-.5-.5h-1a.5.5 0 00-.5.5V21h4v-2.5a.5.5 0 00-.5-.5h-1a.5.5 0 00-.5.5z"/>
                        </svg>
                    </button>
                    <input type="text" id="user-input" placeholder="Ask a question about birds..." class="flex-1 p-3 bg-transparent outline-none rounded-full text-white placeholder-gray-300">
                    <button id="send-btn" class="flex items-center justify-center bg-blue-500/80 text-white w-12 h-12 rounded-full transition duration-200 ease-in-out hover:bg-blue-600/80 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
                <div id="reset-status-message" class="mt-4 text-center text-sm font-medium"></div>
            </div>
            
            <div class="image-audio-info-area flex-1 flex flex-col h-full rounded-xl p-4 gap-4">
                <div class="p-4 bg-gray-100 dark:bg-gray-800 rounded-lg shadow-inner">
                    <h3 class="text-xl font-bold text-white mb-4">Bird Images</h2>
                    <div id="multi-bird-display" class="flex flex-col gap-6 mt-6">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="project-info-box">
        <h2 class="text-xl font-bold mb-4">Project Information</h2>
        <div class="space-y-2 text-center text-sm">
            <p>This is a demonstration of a large language model acting as a domain-specific expert.</p>
            <p>The backend is a Python server wrapped in a Docker container.</p>
            <p>
                <a href="https://github.com/NicolasSpettel/european-bird-chatbot" class="text-blue-300 underline hover:text-blue-200">GitHub</a> | 
                <a href="https://smith.langchain.com/o/da3774d7-02f4-436b-968e-e5e25bae8fb9/projects/p/a6ab4304-8a6c-4da3-b8c3-3b05fb5cdf3f?timeModel=%7B%22duration%22%3A%227d%22%7D" class="text-blue-300 underline hover:text-blue-200">LangSmith</a> |
                <a href="#" class="text-blue-300 underline hover:text-blue-200">LinkedIn</a>
            </p>
        </div>
    </div>

    <button id="reset-memory-btn" title="Reset my memory if I talk nonsense">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m15.356 2H21v-2m-2.144 6A8.001 8.001 0 0119.418 15" />
        </svg>
    </button>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chat-messages');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const exampleQueries = document.getElementById('example-queries');
            const birdListContainer = document.getElementById('bird-list-container');
            const micBtn = document.getElementById('mic-btn');
            const resetButton = document.getElementById('reset-memory-btn');
            const resetStatusMessage = document.getElementById('reset-status-message');
            const multiBirdDisplay = document.getElementById('multi-bird-display');

            const API_ENDPOINT = '/ask';
            const AUDIO_API_ENDPOINT = '/ask_audio';
            const RESET_API_ENDPOINT = '/reset_memory';

            let isRecording = false;
            let mediaRecorder = null;
            let audioChunks = [];

            // Simple Markdown parser for links and images
            const parseMarkdown = (text) => {
                text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, linkText, url) => {
                    return `<a href="${url}" target="_blank" class="text-blue-300 hover:text-blue-200 underline">${linkText}</a>`;
                });
                text = text.replace(/\n/g, '<br>');
                return text;
            };

            const addMessage = (text, sender, transcription = null) => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('flex', 'mb-4');
                const messageContent = document.createElement('div');
                messageContent.classList.add('p-4', 'rounded-xl', 'max-w-[80%]', 'break-words');

                let finalContent = transcription ? `<strong>(Transcription)</strong><br>${text}` : text;
                const parsedText = parseMarkdown(finalContent);

                if (sender === 'user') {
                    messageDiv.classList.add('justify-end');
                    messageContent.classList.add('bg-blue-400/80', 'text-white');
                    messageContent.innerHTML = parsedText;
                    messageDiv.appendChild(messageContent);
                } else {
                    messageDiv.classList.add('justify-start');
                    messageContent.classList.add('bg-gray-200/80', 'text-gray-800', 'flex', 'items-center', 'space-x-2');
                    messageContent.innerHTML = `
                        <img src="https://img.freepik.com/premium-photo/hyperrealistic-portraiture-parrot-with-glasses_899449-28389.jpg" alt="Bot Avatar" class="w-8 h-8 rounded-full">
                        <span>${parsedText}</span>
                        <button class="tts-btn ml-2" title="Listen">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    messageDiv.appendChild(messageContent);
                    
                    const ttsButton = messageDiv.querySelector('.tts-btn');
                    if (ttsButton) {
                        ttsButton.addEventListener('click', () => speakMessage(text));
                    }
                }
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };
            
            const showLoading = () => {
                sendBtn.innerHTML = `
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>`;
                sendBtn.disabled = true;
                userInput.disabled = true;
            };

            const hideLoading = () => {
                sendBtn.innerHTML = `
                    <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>`;
                sendBtn.disabled = false;
                userInput.disabled = false;
            };

            const speakMessage = (text) => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    window.speechSynthesis.speak(utterance);
                } else {
                    console.warn("Text-to-Speech API is not supported in this browser.");
                }
            };
            
            micBtn.addEventListener('click', async () => {
                if (isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;
                    micBtn.classList.remove('bg-red-600/80');
                    micBtn.classList.add('bg-red-500/80');
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];
                        mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                        mediaRecorder.onstop = () => sendAudioMessage(new Blob(audioChunks, { type: 'audio/wav' }));
                        mediaRecorder.start();
                        isRecording = true;
                        micBtn.classList.remove('bg-red-500/80');
                        micBtn.classList.add('bg-red-600/80');
                    } catch (err) {
                        console.error('Error accessing microphone:', err);
                        alert('Microphone access denied. Please enable it to use this feature.');
                    }
                }
            });

            const sendAudioMessage = async (audioBlob) => {
                showLoading();
                const formData = new FormData();
                formData.append('audio', audioBlob, 'audio.wav');
                
                try {
                    const response = await fetch(AUDIO_API_ENDPOINT, {
                        method: 'POST',
                        body: formData,
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    hideLoading();
                    
                    if (data.transcription) {
                        addMessage(data.transcription, 'user', true);
                    }

                    const messageText = data.response;
                    addMessage(messageText, 'bot');
                    
                } catch (error) {
                    console.error('Error fetching bot response with audio:', error);
                    hideLoading();
                    addMessage("Sorry, I couldn't process the audio. Please check your backend.", 'bot');
                }
            };

            const sendMessage = async () => {
                const message = userInput.value.trim();
                if (!message) return;

                addMessage(message, 'user');
                userInput.value = '';
                showLoading();

                try {
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: message }),
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const data = await response.json();
                    hideLoading();

                    const messageText = data.response; 
                    addMessage(messageText, 'bot');
                    
                    multiBirdDisplay.innerHTML = '';


                    if (data.birds && data.birds.length > 0) {
                        // Limit to the first 2 birds
                        data.birds.slice(0, 2).forEach(bird => {
                            const birdCard = document.createElement('div');
                            birdCard.classList.add(
                                'bg-gray-700/60',
                                'p-4',
                                'rounded-xl',
                                'shadow-lg',
                                'text-white',
                                'flex',
                                'flex-col',
                                'items-center',
                                'space-y-4'
                            );

                            // Create species name heading
                            const speciesNameEl = document.createElement('h3');
                            speciesNameEl.classList.add('text-lg', 'font-bold');
                            speciesNameEl.textContent = bird.species;
                            birdCard.appendChild(speciesNameEl);

                            // Create image element
                            if (bird.image_url) {
                                const imgElement = document.createElement('img');
                                imgElement.src = bird.image_url;
                                imgElement.alt = `Image of a ${bird.species}`;
                                imgElement.classList.add('w-full', 'h-auto', 'object-cover', 'rounded-xl', 'shadow');
                                birdCard.appendChild(imgElement);
                            }

                            // Create audio player
                            if (bird.audio_url) {
                                const audioEl = document.createElement('audio');
                                audioEl.classList.add('w-full');
                                audioEl.setAttribute('controls', '');
                                const audioSource = document.createElement('source');
                                audioSource.src = `/stream_audio?url=${encodeURIComponent(bird.audio_url)}`;
                                audioSource.type = 'audio/mpeg';
                                audioEl.appendChild(audioSource);
                                birdCard.appendChild(audioEl);
                            }

                            multiBirdDisplay.appendChild(birdCard);
                        });
                    } else {
                        // Display a message if no birds are found in the structured data
                        multiBirdDisplay.innerHTML = `<p class="p-4 text-white rounded-md bg-white/10 backdrop-blur-md">
                            No bird data found for this query.
                        </p>`;
                    }
                    // --- END of MODIFIED LOGIC ---

                } catch (error) {
                    console.error('Error fetching bot response:', error);
                    hideLoading();
                    addMessage("Sorry, I couldn't connect to the server. Please check the backend.", 'bot');
                }
            };

            const resetMemory = async () => {
                resetStatusMessage.className = 'mt-4 text-center text-sm font-medium text-gray-400';
                resetStatusMessage.textContent = 'Resetting memory...';
                resetButton.disabled = true;

                try {
                    const response = await fetch(RESET_API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                    });

                    const data = await response.json();

                    if (response.ok) {
                        resetStatusMessage.className = 'mt-4 text-center text-sm font-medium text-green-400';
                        resetStatusMessage.textContent = data.message;
                    } else {
                        resetStatusMessage.className = 'mt-4 text-center text-sm font-medium text-red-400';
                        resetStatusMessage.textContent = `Error: ${data.message}`;
                    }
                } catch (error) {
                    resetStatusMessage.className = 'mt-4 text-center text-sm font-medium text-red-400';
                    resetStatusMessage.textContent = 'Failed to connect to the server. Please check your network connection.';
                } finally {
                    resetButton.disabled = false;
                    // Clear the message after 3 seconds
                    setTimeout(() => {
                        resetStatusMessage.textContent = '';
                    }, 3000);
                }
            };

            // --- Bird List and Examples ---
            const birdsByCategory = {
                "Waterfowl": ["Mute Swan", "Whooper Swan", "Bewick's Swan", "Greylag Goose", "Canada Goose", "Barnacle Goose", "Egyptian Goose", "Shelduck", "Mallard", "Gadwall", "Teal", "Shoveler", "Pochard", "Tufted Duck", "Scaup", "Eider", "Long-tailed Duck", "Smew", "Red-breasted Merganser", "Goosander", "Velvet Scoter"],
                "Pheasants, Partridges, and Quails": ["Common Pheasant", "Grey Partridge", "Red-legged Partridge", "Common Quail"],
                "Grebes": ["Little Grebe", "Great Crested Grebe", "Red-necked Grebe", "Slavonian Grebe", "Black-necked Grebe"],
                "Pigeons and Doves": ["Rock Dove", "Stock Dove", "Wood Pigeon", "Collared Dove"],
                "Cuckoos": ["Common Cuckoo"],
                "Nightjars": ["Nightjar"],
                "Swifts": ["Common Swift", "Pallid Swift", "Alpine Swift"],
                "Rails, Crakes, and Coots": ["Water Rail", "Spotted Crake", "Corn Crake", "Moorhen", "Coot"],
                "Cranes": ["Common Crane"],
                "Bustards": ["Great Bustard", "Little Bustard"],
                "Oystercatchers": ["Eurasian Oystercatcher"],
                "Plovers": ["Northern Lapwing", "Little Ringed Plover", "Ringed Plover", "Kentish Plover", "Golden Plover", "Grey Plover", "Dotterel"],
                "Sandpipers and Snipes": ["Common Snipe", "Jack Snipe", "Woodcock", "Black-tailed Godwit", "Bar-tailed Godwit", "Curlew", "Spotted Redshank", "Redshank", "Greenshank", "Green Sandpiper", "Wood Sandpiper", "Common Sandpiper", "Turnstone", "Knot", "Sanderling", "Little Stint", "Temminck's Stint", "Dunlin", "Ruff", "Avocet"],
                "Skuas and Gulls": ["Great Skua", "Arctic Skua", "Pomarine Skua", "Long-tailed Skua", "Mediterranean Gull", "Black-headed Gull", "Little Gull", "Common Gull", "Lesser Black-backed Gull", "Herring Gull", "Yellow-legged Gull", "Great Black-backed Gull", "Kittiwake", "Sabine's Gull", "Ivory Gull", "Glaucous Gull"],
                "Terns": ["Little Tern", "Sandwich Tern", "Common Tern", "Arctic Tern", "Roseate Tern", "Black Tern", "White-winged Black Tern"],
                "Auks": ["Guillemot", "Razorbill", "Black Guillemot", "Little Auk", "Puffin"],
                "Storks": ["White Stork", "Black Stork"],
                "Herons, Egrets, and Bitterns": ["Great Bittern", "Little Bittern", "Grey Heron", "Purple Heron", "Great Egret", "Little Egret", "Cattle Egret", "Squacco Heron", "Night Heron"],
                "Ibises and Spoonbills": ["Glossy Ibis", "Spoonbill"],
                "Birds of Prey": ["Honey Buzzard", "Black Kite", "Red Kite", "White-tailed Eagle", "Golden Eagle", "Short-toed Eagle", "Marsh Harrier", "Hen Harrier", "Montagu's Harrier", "Goshawk", "Sparrowhawk", "Buzzard", "Rough-legged Buzzard", "Osprey", "Kestrel", "Red-footed Falcon", "Merlin", "Hobby", "Peregrine Falcon"],
                "Owls": ["Barn Owl", "Scops Owl", "Eagle Owl", "Tawny Owl", "Long-eared Owl", "Short-eared Owl", "Little Owl", "Pygmy Owl"],
                "Kingfishers": ["Common Kingfisher"],
                "Woodpeckers": ["Wryneck", "Green Woodpecker", "Great Spotted Woodpecker", "Middle Spotted Woodpecker", "Lesser Spotted Woodpecker", "Black Woodpecker", "Grey-headed Woodpecker"],
                "Larks": ["Woodlark", "Skylark", "Crested Lark", "Shore Lark"],
                "Swallows and Martins": ["Sand Martin", "Swallow", "House Martin", "Red-rumped Swallow"],
                "Pipits and Wagtails": ["Tree Pipit", "Meadow Pipit", "Rock Pipit", "Water Pipit", "White Wagtail", "Grey Wagtail", "Yellow Wagtail"],
                "Waxwings": ["Waxwing"],
                "Dippers": ["White-throated Dipper"],
                "Wrens": ["Eurasian Wren"],
                "Accentors": ["Dunnock"],
                "Robins and Chats": ["European Robin", "Common Nightingale", "Bluethroat", "Redstart", "Black Redstart", "Stonechat", "Whinchat", "Wheatear"],
                "Thrushes": ["Ring Ouzel", "Blackbird", "Fieldfare", "Song Thrush", "Redwing", "Mistle Thrush"],
                "Warblers": ["Cetti's Warbler", "Sedge Warbler", "Reed Warbler", "Marsh Warbler", "Icterine Warbler", "Willow Warbler", "Common Chiffchaff", "Wood Warbler", "Greenish Warbler", "Arctic Warbler", "Bonelli's Warbler", "Garden Warbler", "Blackcap", "Lesser Whitethroat", "Common Whitethroat", "Dartford Warbler", "Subalpine Warbler", "Sardinian Warbler", "Melodious Warbler"],
                "Flycatchers": ["Spotted Flycatcher", "Pied Flycatcher", "Collared Flycatcher", "Red-breasted Flycatcher"],
                "Tits": ["Coal Tit", "Marsh Tit", "Willow Tit", "Crested Tit", "Blue Tit", "Great Tit", "Long-tailed Tit"],
                "Nuthatches": ["Eurasian Nuthatch"],
                "Treecreepers": ["Eurasian Treecreeper", "Short-toed Treecreeper"],
                "Shrikes": ["Red-backed Shrike", "Lesser Grey Shrike", "Woodchat Shrike"],
                "Crows and Allies": ["Eurasian Jay", "Magpie", "Spotted Nutcracker", "Chough", "Jackdaw", "Rook", "Carrion Crow", "Hooded Crow", "Raven"],
                "Starlings": ["European Starling", "Rose-coloured Starling"],
                "Sparrows": ["House Sparrow", "Tree Sparrow"],
                "Finches": ["Chaffinch", "Brambling", "Hawfinch", "Greenfinch", "Siskin", "Linnet", "Twite", "Common Redpoll", "Arctic Redpoll", "Two-barred Crossbill", "Common Crossbill", "Parrot Crossbill", "Bullfinch"],
                "Buntings": ["Yellowhammer", "Cirl Bunting", "Rock Bunting", "Ortolan Bunting", "Reed Bunting", "Corn Bunting", "Lapland Bunting", "Snow Bunting"],
                "Miscellaneous": ["Bearded Reedling", "Penduline Tit", "Golden Oriole", "Hoopoe"]
            };
            
            const renderBirdList = () => {
                for (const category in birdsByCategory) {
                    if (birdsByCategory.hasOwnProperty(category)) {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.classList.add('category-container', 'mb-2');

                        const categoryButton = document.createElement('button');
                        categoryButton.classList.add('category-button', 'block', 'w-full', 'px-4', 'py-2', 'bg-gray-700/60', 'text-white', 'rounded-lg', 'text-left', 'hover:bg-gray-600/60', 'transition', 'duration-200', 'ease-in-out', 'flex', 'justify-between', 'items-center');
                        categoryButton.innerHTML = `<span>${category}</span><span class="category-icon">+</span>`;

                        const birdListDiv = document.createElement('div');
                        birdListDiv.classList.add('bird-list', 'hidden', 'pl-4', 'pt-2');

                        birdsByCategory[category].forEach(bird => {
                            const birdButton = document.createElement('button');
                            birdButton.classList.add('bird-button', 'block', 'w-full', 'px-4', 'py-2', 'mb-1', 'bg-gray-700/40', 'text-white', 'rounded-lg', 'text-left', 'hover:bg-gray-600/40', 'transition', 'duration-200', 'ease-in-out');
                            birdButton.textContent = bird;
                            birdListDiv.appendChild(birdButton);
                        });

                        categoryDiv.appendChild(categoryButton);
                        categoryDiv.appendChild(birdListDiv);
                        birdListContainer.appendChild(categoryDiv);

                        categoryButton.addEventListener('click', () => {
                            birdListDiv.classList.toggle('hidden');
                            const icon = categoryButton.querySelector('.category-icon');
                            icon.textContent = birdListDiv.classList.contains('hidden') ? '+' : '-';
                        });
                    }
                }
            };

            // Event listeners
            sendBtn.addEventListener('click', sendMessage);

            userInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            });
            
            birdListContainer.addEventListener('click', (event) => {
                if (event.target.tagName === 'BUTTON' && event.target.classList.contains('bird-button')) {
                    userInput.value = event.target.textContent.trim();
                    sendMessage();
                }
            });

            // Combined example queries listener
            document.querySelectorAll('#example-queries button').forEach(button => {
                button.addEventListener('click', () => {
                    userInput.value = button.textContent.trim();
                    sendMessage();
                });
            });

            resetButton.addEventListener('click', resetMemory);
            
            // Initial rendering of the bird list
            renderBirdList();
        });
    </script>
</body>
</html>